<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<title>GFileSorter Include File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.0.0 on Thu Jan 27 18:45:11 2000 -->
<center>
<a class="qindex"href="index.html">Main Page</a> &nbsp; <a class="qindex"href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex"href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex"href="annotated.html">Compound List</a> &nbsp; <a class="qindex"href="files.html">File List</a> &nbsp; <a class="qindex"href="headers.html">Header Files</a> &nbsp; <a class="qindex"href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex"href="functions.html">Compound Members</a> &nbsp; <a class="qindex"href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>gurlcache.h</h1>This is the verbatim text of the gurlcache.h include file.<div class="fragment"><pre>/*=============================================================================

This code is licensed under the Web3D-blaxxun Community Source License,
provided in distribution file LICENSE.TXT and available online at
http://www.web3D.org/TaskGroups/x3d/blaxxun/Web3D-blaxxunCommunitySourceAgreement.html
and may only be used for non-commercial use as specified in that license.

THE WEB3D CONSORTIUM AND BLAXXUN DO NOT MAKE AND HEREBY DISCLAIM ANY EXPRESS
OR IMPLIED WARRANTIES RELATING TO THIS CODE, INCLUDING BUT NOT LIMITED TO,
WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE, OR ANY WARRANTIES THAT MIGHT ARISE FROM A COURSE OF DEALING, USAGE
OR TRADE PRACTICE.  THE COMMUNITY SOURCE CODE IS PROVIDED UNDER THIS
AGREEMENT "AS IS," WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
INCLUDING, WITHOUT LIMITATION, WARRANTIES THAT THE COMMUNITY SOURCE CODE ARE
FREE OF DEFECTS, MERCHANTABLE, FIT FOR A PARTICULAR PURPOSE OR
NON-INFRINGING OR IN ANY WAY CONSTITUTE THE COMPLETE PRODUCT MARKETED UNDER
THE NAMES GIVEN SAID CODE.

==============================================================================*/
#ifndef _GUrlCache_H
#define _GUrlCache_H
/******************************************************************************
@doc

@module GUrlCache.h - GLView WWW caching |

Copyright (c) 1998      by  blaxxun interactive - Holger Grahn
All rights reserved

Purpose:

Classes:
&lt;c GUrlCache&gt;

Notes:

Changes:

$Revision: 1.10 $
$Log: gurlcache.h,v $
Revision 1.10  1999/07/06 16:55:11  tom
*** empty log message ***

Revision 1.1  1998/03/31 17:29:44  holger
empty message



Todo :

******************************************************************************/


class <a class="code" href="class_greporter.html">GReporter</a>;
class <a class="code" href="class_gurlcache.html">GUrlCache</a>;




//
// GFileInfo
// stores some file information

class <a class="code" href="class_gfileinfo.html">GFileInfo</a> 
{
public :
        time_t creationTime,lastAccessTime,lastWriteTime;
        DWORD  sizeLow,sizeHigh;

        // constructor 
        <a class="code" href="class_gfileinfo.html#a7">GFileInfo</a>() : creationTime(0),lastAccessTime(0),lastWriteTime(0),sizeLow(0),sizeHigh(0) {}

        void <a class="code" href="class_gfileinfo.html#a1">setCreationTime</a>(const time_t t) { creationTime = t; }
        void <a class="code" href="class_gfileinfo.html#a2">setLastAccessTime</a>(const time_t t) { lastAccessTime = t; }
        void <a class="code" href="class_gfileinfo.html#a3">setLastWriteTime</a>(const time_t t) { lastWriteTime = t; }

#ifdef _MFC 
        void <a class="code" href="class_gfileinfo.html#a1">setCreationTime</a>(const CTime t) { creationTime = t.GetTime(); }
        void <a class="code" href="class_gfileinfo.html#a2">setLastAccessTime</a>(const CTime t) { lastAccessTime = t.GetTime(); }
        void <a class="code" href="class_gfileinfo.html#a3">setLastWriteTime</a>(const CTime t) { lastWriteTime = t.GetTime(); }
#endif


        // get the last modified time 
        time_t <a class="code" href="class_gfileinfo.html#a4">getLastModifiedTime</a>() const {

                if ( lastWriteTime &gt; creationTime ) 
                                return lastWriteTime;
                else return creationTime;
        }


        // is the file to old  ?
        gbool <a class="code" href="class_gfileinfo.html#a5">toOld</a>(long days); 
        gbool <a class="code" href="class_gfileinfo.html#a6">olderThen</a>(time_t checkTime); 

};

//
// Sort file entrys
// 



class <a class="code" href="class_gfsortentry.html">GFSortEntry</a> {
public :
        time_t t;
        CString path;

        DWORD length;
        gbool isDir;

        <a class="code" href="class_gfsortentry.html#a0">GFSortEntry</a>(const CString &amp;path_,time_t t_,DWORD l,gbool isDir_=FALSE) : path(path_),t(t_),length(l),isDir(isDir_) { }
        <a class="code" href="class_gfsortentry.html#a3">~GFSortEntry</a>() {} 

};


class <a class="code" href="class_gfilesorter.html">GFileSorter</a> {
public :
                <a class="code" href="class_gfilesorter.html#a9">GFileSorter</a>() :fileSum(0),mustSort(FALSE) {}
                <a class="code" href="class_gfilesorter.html#a10">~GFileSorter</a>();

                <a class="code" href="class_array.html">Array</a>&lt;<a class="code" href="class_gfsortentry.html">GFSortEntry</a> *&gt; entries;
                gbool mustSort;

                // flush the file entries list
                void <a class="code" href="class_gfilesorter.html#a11">Flush</a>();

                // add a new file entry (memory is taken )
                gbool <a class="code" href="class_gfilesorter.html#a3">Add</a>(<a class="code" href="class_gfsortentry.html">GFSortEntry</a> *e); 

                // find an entry 
                <a class="code" href="class_gfsortentry.html">GFSortEntry</a> *<a class="code" href="class_gfilesorter.html#a4">Find</a>(const char *path);

                // sort the entry from oldes to newest 
                gbool <a class="code" href="class_gfilesorter.html#a14">SortTime</a>();
                // sort by name 
                gbool <a class="code" href="class_gfilesorter.html#a15">SortName</a>();

                // add all files in directory to entries 
                gbool <a class="code" href="class_gfilesorter.html#a7">AddFiles</a>(const char *directory,time_t &amp;maxFileTime,BOOL &amp;stop);

                // sum in bytes of all files added so far
                LONGLONG fileSum;               
        
                // delete upTo maxCnt oldest entries, 
                // or stop if maxBytes bytes have been freed up
                gbool <a class="code" href="class_gfilesorter.html#a8">DeleteOldest</a>(<a class="code" href="class_gurlcache.html">GUrlCache</a> &amp;cache,int maxCnt,LONGLONG maxBytes,BOOL &amp;stop);
};

typedef enum {
        GCACHE_ALWAYS,
        GCACHE_ONCE,
        GCACHE_DAYS,
        CCACHE_NEVER
} GCacheMode;


//
// GUrlCache
// caches url in local directorys

class <a class="code" href="class_gurlcache.html">GUrlCache</a> {

public:

        // exclusive access
        CCriticalSection locker;        // 

        BOOL <a class="code" href="class_gurlcache.html#a33">Lock</a>() { return locker.Lock(); }
        BOOL <a class="code" href="class_gurlcache.html#a34">Unlock</a>() { return locker.Unlock(); }

        gbool readCacheEnabled;         
        gbool readMediaCacheEnabled;    // Laurent - Jan.2000
 
        gbool writeCacheEnabled;        

        gbool writeMediaCacheEnabled; // Laurent - Jan.2000

        CString writeCacheDir;          
        gbool writeCacheDirValid;       
        
        CString writeMediaCacheDir;             // Laurent - Jan.2000
        gbool writeMediaCacheDirValid;  // Laurent - Jan.2000
        
        CStringArray readCacheDirs;     
        CStringArray cdroms;            

        CStringArray umelCacheDirs; 
        CString         umelHome;               

        <a class="code" href="class_gfilesorter.html">GFileSorter</a> modifiedList;       // list of urls with modified days 

        
        GCacheMode cacheMode;           

        CTime sessionTime;                      

        CTime <a class="code" href="class_gurlcache.html#a35">getRefreshTime</a>();

        long expirationDays;            

        DWORD minSpaceFree;                     
        LONGLONG spaceUsed;                     
        DWORD maxSpaceUsed;                     

        // some stats
        DWORD bytesWrittenToCache;
        DWORD bytesReadFromCache;

        time_t lastCacheFlushTime;
        time_t checkInterval;
        
        CString writeCacheDrive;                // directory driver path for r/w cache for checking diskspace
        CString writeMediaCacheDrive;   // Laurent - Jan.2000

        BOOL cleanerBusy;                               // CheckCache is currently running
        BOOL stop;
        
        gbool needCacheCleaning;                        // flag if cache cleaning needed
        DWORD lastDiskSpaceCheck;               // time last diskspace check was called         
        

        <a class="code" href="class_gurlcache.html#a36">GUrlCache</a>();
        <a class="code" href="class_gurlcache.html#a37">~GUrlCache</a>();

        gbool <a class="code" href="class_gurlcache.html#a5">SetWriteCacheDirectory</a>(const char *dir);

        gbool <a class="code" href="class_gurlcache.html#a6">SetWriteMediaCacheDirectory</a>(const char *dir); // Laurent - Jan.2000

        gbool <a class="code" href="class_gurlcache.html#a7">AddCacheDirectory</a>(const char *dir,CStringArray &amp;readCacheDirs);

        gbool <a class="code" href="class_gurlcache.html#a8">SetReadCacheDirectoryPath</a>(const char *dirs);
        
        void <a class="code" href="class_gurlcache.html#a42">ClearReadCacheDirectorys</a>() { readCacheDirs.RemoveAll(); }

        gbool <a class="code" href="class_gurlcache.html#a10">SetUmelDirectoryPath</a>(const char *dirs);
        
        void <a class="code" href="class_gurlcache.html#a44">ClearUmelDirectorys</a>() { umelCacheDirs.RemoveAll(); }


        gbool <a class="code" href="class_gurlcache.html#a12">CreateDirectory</a>(CString &amp;directory); 
        
        gbool <a class="code" href="class_gurlcache.html#a13">ExistsDirectory</a>(CString &amp;directory); 

        LONGLONG <a class="code" href="class_gurlcache.html#a47">GetFreeDiskSpace</a>();


        gbool <a class="code" href="class_gurlcache.html#a15">UrlToFilePath</a>(const char *url,CString &amp;relFilePath);
        
        gbool <a class="code" href="class_gurlcache.html#a16">Combine</a>(const CString &amp;directory,const CString relFilePath,CString &amp;absFilePath);

        gbool <a class="code" href="class_gurlcache.html#a17">CombineCreateDirectory</a>(const char *directoy, const char * relPath,CString &amp;absFilePath); 


        gbool <a class="code" href="class_gurlcache.html#a18">Exists</a>(const char * absFilePath,<a class="code" href="class_gfileinfo.html">GFileInfo</a> *info);

        gbool <a class="code" href="class_gurlcache.html#a19">Expired</a>(const char * absFilePath,<a class="code" href="class_gfileinfo.html">GFileInfo</a> &amp;info);

        // copy the file from src to dest
        // if creationTime &gt; 0 set the lastModified  &amp; creationDate to time 
        gbool <a class="code" href="class_gurlcache.html#a20">CopyFile</a>(const CString &amp;srcFilePath,const CString &amp;destFilePath,gbool checkDir,time_t creationTime);


        gbool <a class="code" href="class_gurlcache.html#a21">SaveUrl</a>(const char *url,const CString &amp;srcFilePath,time_t creationTime,CString &amp;cacheFileName);

        gbool <a class="code" href="class_gurlcache.html#a22">SetUrlModified</a>(const char *url,time_t lastModifiedTime);
        gbool <a class="code" href="class_gurlcache.html#a23">GetUrlModified</a>(const char *url,time_t  &amp;lastModifiedTime);

        // check cache for already  downloaded url 
        // result TRUE : srcFilePath contains local file, info file info
        // if checkTime, cache creation time must be &gt;= checkTime 
        //
        gbool <a class="code" href="class_gurlcache.html#a24">GetUrl</a>(const char *url,time_t checkTime, CString &amp;srcFilePath,<a class="code" href="class_gfileinfo.html">GFileInfo</a> &amp;info);

#if 0
        // check cache for already  downloaded url 
        gbool <a class="code" href="class_gurlcache.html#a24">GetUrl</a>(const char *url,CString &amp;srcFilePath);

        // check cache for already  downloaded url 
        gbool <a class="code" href="class_gurlcache.html#a24">GetUrl</a>(const char *url, time_t checkTime, CString &amp;srcFilePath);
#endif

        // recursively remove a file branch 
        gbool <a class="code" href="class_gurlcache.html#a25">RemoveFiles</a>(const char *directory, time_t olderThan);

        // remove empty directory
        gbool <a class="code" href="class_gurlcache.html#a26">RemoveDirectory</a>(const char *directory); 

        // remove file
        gbool <a class="code" href="class_gurlcache.html#a27">RemoveFile</a>(const char *fileName); 

        // remove oldest files 
        gbool <a class="code" href="class_gurlcache.html#a28">RemoveOldestFile</a>(const char *directory, time_t olderThan,DWORD cacheLimit);
        
        // query cache status 
        // variables must be 0 at entry
        gbool <a class="code" href="class_gurlcache.html#a29">GetCacheStats</a>(const char *directory, time_t &amp;oldest,DWORD &amp;spaceInUse, int &amp;filesInUse);

        // check if cache needs cleaning
        gbool <a class="code" href="class_gurlcache.html#a30">NeedCacheCleaning</a>(DWORD theTime);

        // check the cache to clean up stuff
        gbool <a class="code" href="class_gurlcache.html#a64">CheckCache</a>();


        // check UMEL directories from UMEL urn
        // result TRUE : srcFilePath contains local file, info file info
        //

        gbool <a class="code" href="class_gurlcache.html#a32">GetUmelUrl</a>(const char *url, CString &amp;srcFilePath,<a class="code" href="class_gfileinfo.html">GFileInfo</a> &amp;info, gbool &amp;isFile);

};

// global :
// the global urlcache
extern <a class="code" href="class_gurlcache.html">GUrlCache</a> theCache;

// AFX_THREADPROC
// cache cleaner thread function
UINT G__cdecl <a class="code" href="gurlcache.h.html#a0">CUrlCacheCleanerThread</a> (LPVOID pParam);




#endif // _GUrlCache_H
</div></pre><hr><address><small>Generated at Thu Jan 27 18:45:11 2000 for blaxxunContact3D by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align=center border=0 
width=118 height=53></a> 1.0.0 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy; 1997-1999</small></address>
</body>
</html>
